#!/usr/bin/env BQN
# 2048 game
# The game is controlled with the vim movement keys:
# h: left, j: down, k: up, l: right, q: quit
# needs a VT-100 compatible terminal

Mergeâ†{ğ•© 0âŠ¸â‰ âŠ¸/â†© â‹„ mâ†<`=âŸœÂ«ğ•© â‹„ 4â†‘(Â¬Â»m)/ğ•©Ã—1+m}âŒ¾âŒ½ # Merge a single row to the right
Stepâ†MergeË˜    # Merges each row of the board
Upâ†StepâŒ¾(âŒ½â‰âˆ˜âŒ½) # Each direction merges the board
Downâ†StepâŒ¾â‰    # by rotating it to the correct orientation, merging the rows
Rightâ†Step     # and reversing the rotation
Leftâ†StepâŒ¾(âŒ½Ë˜)
# Spawns a 2 or a 4 (10% chance) at a random empty position
Spawnâ†{iâ†â€¢rand.Rangeâˆ˜â‰ âŠ¸âŠ‘(0âŠ¸= /â—‹â¥Š â†•âˆ˜â‰¢)ğ•© â‹„ (â€¢rand.Rangeâˆ˜â‰ âŠ¸âŠ‘9â€¿1/2â€¿4)âŒ¾(iâŠ¸âŠ‘) ğ•©}
Loseâ†Leftâˆ˜Rightâˆ˜Downâˆ˜UpâŠ¸â‰¡ # Losing condition, no moves change the board
Winâ†âˆ¨Â´Â·âˆ¨Ë2048âŠ¸= #  Winning condition, 2048!

Quitâ†{â€¢Out eâˆ¾"[?12l"âˆ¾eâˆ¾"[?25h" â‹„ â€¢term.RawMode 0 â‹„ â€¢Exit ğ•©} # Restores the terminal and exits
Displayâ†{ # Displays the board, score and controls
    â€¢Out eâˆ¾"[H"âˆ¾eâˆ¾"[2J" # Cursor to origin and clear screen
    â€¢Out "Controls: h: left, j: down, k: up, l: right, q: quit"
    â€¢Show ğ•©
    â€¢Out "score: "âˆ¾â€¢Repr âŒˆÂ´âŒˆË ğ•©
}

boardâ†Spawn 4â€¿4â¥Š0
eâ†@+27 # Escape character for the ANSI escape codes
â€¢term.RawMode 1
â€¢Out eâˆ¾"[?25l"âˆ¾eâˆ¾"[2J"âˆ¾eâˆ¾"[H" # Cursor to origin, hide it and clear screen
{ğ•¤â‹„
  Display board
  {ğ•¤â‹„â€¢Out "You win!" â‹„ Quit 0}âŸWin board
  {ğ•¤â‹„â€¢Out "You lose!"â‹„ Quit 1}âŸLose board
  keyâ†â€¢term.CharB @ # Read key
  âŠ‘keyâˆŠ"hjklq"? # Valid key?
    {ğ•¤â‹„ Quit 0}âŸ(key='q')@ # Quit key?
    moveâ†âŠ‘(key="hjkl")/Leftâ€¿Downâ€¿Upâ€¿Right # Get movement function from the key
    {ğ•¤â‹„boardâ†©Spawnâˆ˜Move ğ•©}âŸ(MoveâŠ¸â‰¢) board # Generate the next board if the move is valid
  ; @
}â€¢_While_{ğ•¤â‹„1}@
